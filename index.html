<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treinamento de Inglês</title>
    
    <style>
        @font-face {
            font-family: 'museo-sans-rounded';
            src: url('https://d7mj4aqfscim2.cloudfront.net/proxy/fonts/museo/museosansrounded-700-webfont.eot');
            src: url('https://d7mj4aqfscim2.cloudfront.net/proxy/fonts/museo/museosansrounded-700-webfont.eot?#iefix') format('embedded-opentype'),
                 url('https://d7mj4aqfscim2.cloudfront.net/proxy/fonts/museo/museosansrounded-700-webfont.woff2') format('woff2'),
                 url('https://d7mj4aqfscim2.cloudfront.net/proxy/fonts/museo/museosansrounded-700-webfont.woff') format('woff'),
                 url('https://d7mj4aqfscim2.cloudfront.com/proxy/fonts/museo/museosansrounded-700-webfont.svg#museo_sans_rounded700') format('svg');
            font-weight: 700;
            font-style: normal;
        }

        body {
            font-family: 'museo-sans-rounded', sans-serif;
            background-color: white;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #4b4b4b;
        }

        .main-content-wrapper {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out;
        }
        
        .container {
            position: relative;
            width: 100%;
            max-width: 600px;
            background-color: transparent;
            padding: 20px;
            text-align: center;
        }

        .content-flex-container {
            display: block; 
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 40px;
            height: 40px;
            margin-right: 12px;
        }

        .header h1 {
            font-size: 24px;
            color: #2d2d2d;
            font-weight: 600;
            margin: 0;
        }

        .question-box {
            padding: 30px 20px;
            background-color: white;
            margin-bottom: 20px;
            flex: 1; 
        }

        .word-to-translate {
            font-size: 32px;
            color: #2d2d2d;
            margin: 20px 0 10px;
            font-weight: 600;
        }

        .word-and-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0 10px;
        }
        
        .info-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #e5e5e5;
            color: #a5a5a5;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            visibility: hidden;
            opacity: 0;
            user-select: none;
        }
        
        .info-icon.placeholder {
            visibility: hidden;
            opacity: 0;
        }

        .info-icon.visible {
            visibility: visible;
            opacity: 1;
        }
        
        .alternative-translations {
            background-color: #f7f7f7;
            padding: 15px;
            border-radius: 8px;
            font-size: 15px;
            color: #666;
            display: none;
            text-align: left;
            width: 300px;
            
            position: absolute;
            top: 20px;
            left: 100%;
            margin-left: 20px;
        }

        .alternative-translations h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            color: #2d2d2d;
        }
        
        .alternative-translations p {
            margin: 0 0 10px 0;
            line-height: 1.4;
        }
        
        .alternative-translations p:last-child {
            margin-bottom: 0;
        }
        
        .alternative-translations .translation-item {
            display: block;
            margin-bottom: 8px;
        }
        
        .alternative-translations .translation-item:last-child {
            margin-bottom: 0;
        }
        
        .alternative-translations strong {
            color: #2d2d2d;
            font-weight: 700;
        }
        
        .alternative-translations em {
            color: #999;
            font-style: normal;
            font-size: 14px;
        }
        
        .answer-input-container {
            position: relative;
            margin-top: 16px;
        }

        .answer-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e5e5;
            border-bottom-width: 5px;
            border-radius: 9px;
            font-size: 16px;
            text-align: center;
            box-sizing: border-box;
            transition: all 0.2s;
            color: #2d2d2d;
            font-family: 'museo-sans-rounded', sans-serif;
            font-weight: 700;
            background-color: #fff;
        }

        .answer-input:focus {
            outline: none;
            border-color: #e5e5e5;
            border-bottom-width: 5px;
            box-shadow: none;
        }
        
        .answer-input[disabled] {
            cursor: not-allowed;
            background-color: #f7f7f7;
            color: #a5a5a5;
        }

        .answer-input::placeholder {
            color: #666 !important;
            font-family: 'museo-sans-rounded', sans-serif !important;
            font-weight: 700;
            opacity: 1;
        }
        
        .answer-input.correct {
            border-color: #58cc02;
            border-bottom-color: #4bb302;
            background-color: #d7ffb8;
            color: #58cc02;
        }
        
        .answer-input.incorrect {
            border-color: #ff4b4b;
            border-bottom-color: #e04343;
            background-color: #ffdde0;
            color: #ff4b4b;
        }

        .feedback-message {
            margin-top: 10px;
            min-height: 20px;
            font-weight: bold;
        }

        .feedback-message.correct {
            color: #58cc02;
        }

        .feedback-message.incorrect {
            color: #ff4b4b;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }
        
        .check-button {
            width: 50%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #58cc02;
            box-shadow: 0 4px 0 #4bb302;
        }

        .check-button:hover {
            background-color: #5de604;
        }

        .check-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #4bb302;
        }

        .next-button {
            width: 50%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #1cb0f6;
            box-shadow: 0 4px 0 #1898e0;
        }

        .next-button:hover {
            background-color: #20b6ff;
        }

        .next-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1898e0;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #e5e5e5;
            border-radius: 10px;
            margin: 30px 0;
            height: 6px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 10px;
            background-color: #58cc02;
            transition: width 0.4s ease;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .menu {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .menu h2 {
            font-size: 24px;
            color: #2d2d2d;
            margin-top: 0;
        }

        .menu p {
            font-size: 16px;
            line-height: 1.5;
            color: #666;
            margin-bottom: 20px;
            text-align: left;
        }
        .menu p.center {
            text-align: center;
        }
        
        .menu .inline-info-icon-wrapper {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .menu .info-icon {
            position: relative;
            top: 2px;
            visibility: visible;
            opacity: 1;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .menu-buttons button {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e5e5;
            border-bottom-width: 5px;
            border-radius: 9px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            background-color: #fff;
            color: #666;
            transition: all 0.2s;
        }

        .menu-buttons button.selected {
            background-color: #f0f0f0; 
            color: #2d2d2db5; 
            border-color: #d0d0d0; 
            border-bottom-color: #b0b0b0; 
        }

        .menu-buttons button:not(.selected):hover {
            background-color: #f7f7f7;
            border-color: #d0d0d0;
            color: #4b4b4b;
        }

        .start-button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #58cc02;
            box-shadow: 0 4px 0 #4bb302;
        }
        
        .start-button:hover {
            background-color: #5de604;
        }

        .start-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #4bb302;
        }

        /* --- Novo: Estilos para o menu de palavras personalizadas --- */
        #custom-words-overlay .menu {
            max-width: 500px;
        }

        #search-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }

        #search-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e5e5e5;
            border-radius: 9px;
            font-size: 16px;
            box-sizing: border-box;
        }

        #search-results {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 9px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #2d2d2d;
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .search-item:hover {
            background-color: #f7f7f7;
        }

        .search-item .word-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .search-item .word-info strong {
            font-size: 16px;
            font-weight: 700;
        }

        .search-item .word-info em {
            font-size: 14px;
            color: #999;
            font-style: normal;
        }

        .action-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        
        .action-button:active {
            transform: scale(0.9);
        }

        .add-button {
            background-color: #58cc02;
            box-shadow: 0 2px 0 #4bb302;
        }

        .remove-button {
            background-color: #ff4b4b;
            box-shadow: 0 2px 0 #e04343;
        }
        
        #selected-words-list {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e5e5e5;
            text-align: left;
        }
        
        #selected-words-list h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #2d2d2d;
        }

        .selected-word-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .selected-word-item:last-child {
            border-bottom: none;
        }
        
        .selected-word-item span {
            font-weight: 700;
        }
        
        .custom-words-notice {
            margin-top: 20px;
            font-size: 14px;
            color: #999;
        }

        /* Responsividade para telas menores */
        @media (max-width: 960px) {
            .alternative-translations {
                position: static;
                width: 100%;
                margin-top: 20px;
                margin-left: 0;
            }
            .container {
                max-width: 600px;
            }
        }

        /* Responsividade para botões em telas pequenas */
        @media (max-width: 600px) {
            .check-button, .next-button {
                width: 100%;
            }
            .button-container {
                display: block;
            }
        }
    </style>

</head>
<body>

    <div id="main-content-wrapper" class="main-content-wrapper">
        <div class="container">
            <header class="header">
            </header>
            <div class="content-flex-container">
                <main class="main-content">
                    <div id="question-box" class="question-box">
                        <div class="word-and-info">
                            <span class="info-icon placeholder"></span>
                            <h2 id="word-to-translate" class="word-to-translate"></h2>
                            <span id="info-icon" class="info-icon">i</span>
                        </div>
                        <div class="answer-input-container">
                            <input type="text" id="answer-input" class="answer-input" placeholder="Digite sua resposta">
                        </div>
                        <p id="feedback-message" class="feedback-message"></p>
                        <div class="button-container">
                            <button id="check-button" class="check-button">Verificar</button>
                        </div>
                    </div>
                </main>
            </div>
            <div id="alternative-translations" class="alternative-translations">
                <h3>Traduções e exemplos</h3>
                <div id="alternatives-list-content"></div>
            </div>
        </div>
    </div>

    <div id="game-selection-overlay" class="overlay">
        <div class="menu">
            <h2 class="center">Escolha o seu treino!</h2>
            <p>Selecione a categoria de palavras que você quer praticar hoje.</p>
            <div id="game-selection-buttons" class="menu-buttons">
                <button data-category="verbs">Verbos</button>
                <button data-category="phrasal-verbs">Phrasal Verbs</button>
                <button data-category="adverbs">Advérbios</button>
                <button data-category="nouns">Substantivos</button>
                <button data-category="adjectives">Adjetivos</button>
                <button data-category="custom-words">Editar</button>
                <button data-category="all" class="selected">Todos os modos</button>
                <button id="dictionary-button">Dicionário</button>
            </div>
            <p class="center">
                <button id="select-game-button" class="start-button">Próximo</button>
            </p>
        </div>
    </div>

    <div id="custom-words-overlay" class="overlay" style="display: none;">
        <div class="menu">
            <h2>Selecione suas palavras</h2>
            <p>Digite para buscar palavras na lista e clique em <strong>+</strong> para adicionar ou <strong>x</strong> para remover do seu treino.</p>
            
            <div id="search-container">
                <input type="text" id="search-input" placeholder="Buscar palavra (português ou inglês)">
                <ul id="search-results" style="display: none;"></ul>
            </div>
            
            <div id="selected-words-list">
                <h3>Palavras no seu treino:</h3>
                <div id="selected-words-container">
                    <p class="custom-words-notice">Nenhuma palavra selecionada. Use a busca para adicionar.</p>
                </div>
            </div>

            <p class="center" style="margin-top: 20px;">
                <button id="start-custom-game-button" class="start-button" disabled>Começar treino</button>
            </p>
        </div>
    </div>

    <div id="direction-overlay" class="overlay" style="display: none;">
        <div class="menu">
            <h2 class="center">Escolha a direção!</h2>
            <div id="direction-buttons" class="menu-buttons">
                <button data-direction="pt-en" class="selected">Português para Inglês</button>
                <button data-direction="en-pt">Inglês para Português</button>
            </div>
            <p class="center">
                <button id="select-direction-button" class="start-button">Próximo</button>
            </p>
        </div>
    </div>

    <div id="welcome-overlay" class="overlay" style="display: none;">
        <div class="menu">
            <h2 class="center">Bem-vindo!</h2>
            <p id="welcome-text">Seu objetivo é traduzir as palavras do português para o inglês.</p>
            <p>O sistema vai repetir as palavras que você mais erra, garantindo um aprendizado mais eficiente. As que você já domina, aparecerão com menos frequência.</p>
            <p>Após responder, você pode clicar no ícone <span class="inline-info-icon-wrapper"><span class="info-icon">i</span></span> ou pressionar a tecla **/** (barra) para ver outras traduções e exemplos da palavra em frases.</p>
            <p class="center">
                <button id="start-button" class="start-button">Começar</button>
            </p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const vocabulary = [
            { portuguese: 'noiva', english: 'bride', category: 'nouns', example: 'The bride looked beautiful in her dress.', alternatives: [{ translation: 'betrothed', example: 'The betrothed couple is planning their wedding.' }] },
            { portuguese: 'entalhe', english: 'carving', category: 'nouns', example: 'He showed me a beautiful wood carving.' },
            { portuguese: 'terras baixas', english: 'lowland', category: 'nouns', example: 'They live in the lowland area near the river.' },
            { portuguese: 'babador', english: 'bib', category: 'nouns', example: 'The baby wore a bib during dinner.' },
            { portuguese: 'traço', english: 'trace', category: 'nouns', example: 'There was no trace of him left.', alternatives: [{ translation: 'mark', example: 'The detective found a mark on the wall.' }] },
            { portuguese: 'mancha', english: 'blemish', category: 'nouns', example: 'She was worried about a small blemish on her skin.' },
            { portuguese: 'quantidade', english: 'amount', category: 'nouns', example: 'A large amount of money was needed for the project.' },
            { portuguese: 'esboço', english: 'sketch', category: 'nouns', example: 'The artist made a quick sketch of the landscape.' },
            { portuguese: 'iminente', english: 'impending', category: 'adjectives', example: 'The country was preparing for an impending storm.' },
            { portuguese: 'apesar de', english: 'despite', category: 'prepositions', example: 'Despite the rain, we still had a great time.' },
            { portuguese: 'corte de gastos', english: 'retrenchment', category: 'nouns', example: 'The company is undergoing a period of retrenchment.' },
            { portuguese: 'empréstimo', english: 'loan', category: 'nouns', example: 'He took out a loan to buy a new car.' },
            { portuguese: 'vantagem', english: 'advantage', category: 'nouns', example: 'Speaking two languages is a great advantage.' },
            { portuguese: 'reitor', english: 'dean', category: 'nouns', example: 'The new dean of the university was announced today.' },
            { portuguese: 'colo', english: 'lap', category: 'nouns', example: 'The cat sat on my lap.' },
            { portuguese: 'diminuir (volume)', english: 'turn it down', category: 'phrasal-verbs', example: 'Please turn it down, the music is too loud.' },
            { portuguese: 'recusar', english: 'turn it down', category: 'phrasal-verbs', example: 'I think I will turn it down because I do not agree with the values of the company.', alternatives: [{ translation: 'decline', example: 'He decided to decline the job offer.' }] },
            { portuguese: 'valer a pena', english: 'worth the time', category: 'expressions', example: 'Studying a new language is always worth the time.' },
            { portuguese: 'aproveitar ao máximo', english: 'to make the most of it', category: 'expressions', example: 'You should make the most of your vacation.' },
            { portuguese: 'ida e volta', english: 'back and forth', category: 'adverbs', example: 'We drove back and forth between the two cities.' },
            { portuguese: 'ser questionado', english: 'to be grilled', category: 'idioms', example: 'He was grilled by reporters about his decisions.' },
            { portuguese: 'demorou um pouco', english: 'it took a while', category: 'expressions', example: 'It took a while, but I finally finished the project.' },
            { portuguese: 'mas pelo menos', english: 'but at least', category: 'conjunctions', example: 'It was a difficult journey, but at least we made it safely.' },
            { portuguese: 'ansioso', english: 'eager', category: 'adjectives', example: 'She was eager to start her new job.' },
            { portuguese: 'ocioso', english: 'idle', category: 'adjectives', example: 'He spent the day being completely idle.' },
            { portuguese: 'concedido', english: 'granted', category: 'verbs', example: 'The judge granted him bail.' },
            { portuguese: 'dar como certo', english: 'take for granted', category: 'idioms', example: 'He took her help for granted.' },
            { portuguese: 'padronizado', english: 'standardized', category: 'adjectives', example: 'The test was standardized across all schools.' },
            { portuguese: 'apenas', english: 'merely', category: 'adverbs', example: 'He was merely asking a question.' },
            { portuguese: 'ultimamente', english: 'lately', category: 'adverbs', example: 'I haven\'t seen him lately.' },
            { portuguese: 'menos', english: 'fewer', category: 'determiners', example: 'There are fewer books on the shelf now.', alternatives: [{ translation: 'least', example: 'This box has the least items of all.' }] },
            { portuguese: 'prontamente', english: 'readily', category: 'adverbs', example: 'He readily agreed to help with the project.' },
            { portuguese: 'promessa solene', english: 'pledge', category: 'nouns', example: 'They made a pledge to protect the environment.' },
            { portuguese: 'compromisso', english: 'commitment', category: 'nouns', example: 'Marriage is a serious commitment.', alternatives: [{ translation: 'pledge', example: 'They made a pledge to protect the environment.' }] },
            { portuguese: 'nomear', english: 'to appoint', category: 'verbs', example: 'They will appoint a new manager next week.' },
            { portuguese: 'designar', english: 'to designate', category: 'verbs', example: 'The team will designate a new leader.' },
            { portuguese: 'lançar', english: 'to throw', category: 'verbs', example: 'He threw the ball to his friend.' },
            { portuguese: 'arremessar com força', english: 'to hurl', category: 'verbs', example: 'He hurled the rock into the water.', alternatives: [{ translation: 'throw hard', example: 'He threw the ball hard across the field.' }] },
            { portuguese: 'jogar de leve', english: 'to toss', category: 'verbs', example: 'Toss me the keys, please.', alternatives: [{ translation: 'throw gently', example: 'She threw the ball gently to her friend.' }] },
            { portuguese: 'soneca', english: 'snooze', category: 'nouns', example: 'I took a quick snooze on the couch.' },
            { portuguese: 'quadro', english: 'board', category: 'nouns', example: 'Write the answer on the board.' },
            { portuguese: 'embarcar', english: 'to board', category: 'verbs', example: 'We are ready to board the plane.' },
            { portuguese: 'fornecer', english: 'to provide', category: 'verbs', example: 'We will provide all the necessary materials.', alternatives: [{ translation: 'provide', example: 'The school provides lunch for the students.' }] },
            { portuguese: 'reunir', english: 'to gather', category: 'verbs', example: 'We will gather all the information we need.', alternatives: [{ translation: 'collect', example: 'Please collect the papers from the students.' }] },
            { portuguese: 'encantar', english: 'to enchant', category: 'verbs', example: 'The music will enchant the audience.', alternatives: [{ translation: 'enchant', example: 'The story enchanted all the children.' }] }
        ];
        
        const progress = new Map();
        vocabulary.forEach(word => progress.set(word.portuguese, { correct: 0, incorrect: 0, lastSeen: 0 }));

        let currentWord;
        let isAnswered = false;
        let selectedCategory = 'all';
        let selectedDirection = 'pt-en'; 
        let currentVocabulary = [];
        let sessionCount = 0;
        let customWords = new Set();

        const wordToTranslateEl = document.getElementById('word-to-translate');
        const answerInput = document.getElementById('answer-input');
        const checkButton = document.getElementById('check-button');
        const feedbackMessageEl = document.getElementById('feedback-message');
        const infoIcon = document.getElementById('info-icon');
        const alternativeTranslationsBox = document.getElementById('alternative-translations');
        const alternativesListContent = document.getElementById('alternatives-list-content');
        const buttonContainer = document.querySelector('.button-container');

        const gameSelectionOverlay = document.getElementById('game-selection-overlay');
        const gameSelectionButtonsContainer = document.getElementById('game-selection-buttons');
        const selectGameButton = document.getElementById('select-game-button');
        
        const directionOverlay = document.getElementById('direction-overlay');
        const directionButtonsContainer = document.getElementById('direction-buttons');
        const selectDirectionButton = document.getElementById('select-direction-button');

        const welcomeOverlay = document.getElementById('welcome-overlay');
        const welcomeText = document.getElementById('welcome-text');
        const startButton = document.getElementById('start-button');
        const mainContentWrapper = document.getElementById('main-content-wrapper');
        
        const customWordsOverlay = document.getElementById('custom-words-overlay');
        const searchInput = document.getElementById('search-input');
        const searchResultsList = document.getElementById('search-results');
        const selectedWordsContainer = document.getElementById('selected-words-container');
        const startCustomGameButton = document.getElementById('start-custom-game-button');
        const dictionaryButton = document.getElementById('dictionary-button');
        
        function filterVocabulary(category) {
            if (category === 'all') {
                return vocabulary;
            }
            if (category === 'custom-words') {
                return vocabulary.filter(word => customWords.has(word.portuguese));
            }
            return vocabulary.filter(word => word.category === category);
        }

        function getRandomWord() {
            sessionCount++;
            
            // Primeiro, tentamos selecionar palavras com maior taxa de erro
            const wordsWithErrors = currentVocabulary.filter(word => {
                const wordProgress = progress.get(word.portuguese);
                return wordProgress.incorrect > 0 && 
                       (wordProgress.correct === 0 || wordProgress.incorrect / (wordProgress.correct + wordProgress.incorrect) > 0.5);
            });
            
            if (wordsWithErrors.length > 0 && (sessionCount % 3 !== 0)) {
                // 2/3 das vezes, selecionamos das palavras com erros
                const randomIndex = Math.floor(Math.random() * wordsWithErrors.length);
                return wordsWithErrors[randomIndex];
            }
            
            // O restante do tempo, usamos o sistema de pesos
            const weightedWords = [];
            currentVocabulary.forEach(word => {
                const wordProgress = progress.get(word.portuguese) || { correct: 0, incorrect: 0, lastSeen: 0 };
                
                // Peso baseado em erros vs acertos
                let weight = Math.max(1, (wordProgress.incorrect + 1) * 3 - wordProgress.correct);
                
                // Aumenta o peso se a palavra não foi vista há muito tempo
                const sessionsSinceLastSeen = sessionCount - wordProgress.lastSeen;
                if (sessionsSinceLastSeen > 10) {
                    weight *= 2;
                } else if (sessionsSinceLastSeen > 5) {
                    weight *= 1.5;
                }
                
                for (let i = 0; i < weight; i++) {
                    weightedWords.push(word);
                }
            });

            const randomIndex = Math.floor(Math.random() * weightedWords.length);
            return weightedWords[randomIndex];
        }

        function showNextWord() {
            if (currentVocabulary.length === 0) {
                wordToTranslateEl.textContent = 'Fim do treino!';
                answerInput.style.display = 'none';
                checkButton.style.display = 'none';
                return;
            }
            
            currentWord = getRandomWord();
            if (currentWord) {
                isAnswered = false;
                
                // Atualiza o lastSeen
                const wordProgress = progress.get(currentWord.portuguese);
                if (wordProgress) {
                    wordProgress.lastSeen = sessionCount;
                    progress.set(currentWord.portuguese, wordProgress);
                }
                
                if (selectedDirection === 'pt-en') {
                    wordToTranslateEl.textContent = currentWord.portuguese;
                    answerInput.placeholder = 'Digite sua resposta em inglês';
                } else {
                    wordToTranslateEl.textContent = currentWord.english;
                    answerInput.placeholder = 'Digite sua resposta em português';
                }
                
                answerInput.value = '';
                answerInput.classList.remove('correct', 'incorrect');
                answerInput.removeAttribute('disabled'); 
                
                checkButton.textContent = 'Verificar';
                checkButton.classList.remove('next-button');
                checkButton.classList.add('check-button');
                feedbackMessageEl.textContent = '';
                feedbackMessageEl.classList.remove('correct', 'incorrect');
                
                infoIcon.classList.remove('visible');
                alternativeTranslationsBox.style.display = 'none';
                
                setTimeout(() => answerInput.focus(), 0);
            }
        }

        function calculateSimilarity(str1, str2) {
            // Remove "to " do início das strings para comparação
            const cleanStr1 = str1.replace(/^(to\s)/, '').toLowerCase();
            const cleanStr2 = str2.replace(/^(to\s)/, '').toLowerCase();
            
            if (cleanStr1 === cleanStr2) return 1.0;
            
            const len1 = cleanStr1.length;
            const len2 = cleanStr2.length;
            const maxLen = Math.max(len1, len2);
            
            // Calcula a distância de Levenshtein
            const matrix = [];
            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = cleanStr1[i-1] === cleanStr2[j-1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i-1][j] + 1,    // deleção
                        matrix[i][j-1] + 1,     // inserção
                        matrix[i-1][j-1] + cost // substituição
                    );
                }
            }
            
            const distance = matrix[len1][len2];
            return 1 - (distance / maxLen);
        }

        function checkAnswer() {
            if (isAnswered) {
                showNextWord();
                return;
            }

            if (!currentWord) return;

            const userAnswer = answerInput.value.trim();
            let correctAnswers = [];
            
            if (selectedDirection === 'pt-en') {
                correctAnswers.push(currentWord.english);
                if (currentWord.alternatives) {
                    currentWord.alternatives.forEach(alt => correctAnswers.push(alt.translation));
                }
            } else {
                correctAnswers.push(currentWord.portuguese);
            }

            // Verifica similaridade para cada resposta correta
            let maxSimilarity = 0;
            let bestMatch = '';
            
            correctAnswers.forEach(correctAnswer => {
                const similarity = calculateSimilarity(userAnswer, correctAnswer);
                if (similarity > maxSimilarity) {
                    maxSimilarity = similarity;
                    bestMatch = correctAnswer;
                }
            });

            const isCorrect = maxSimilarity >= 0.8; // 80% de similaridade

            if (isCorrect) {
                feedbackMessageEl.textContent = 'Correto!';
                if (maxSimilarity < 1.0) {
                    feedbackMessageEl.textContent += ` (Você digitou "${userAnswer}", mas a resposta exata é "${bestMatch}")`;
                }
                feedbackMessageEl.classList.add('correct');
                answerInput.classList.add('correct');
                const wordProgress = progress.get(currentWord.portuguese) || { correct: 0, incorrect: 0, lastSeen: 0 };
                wordProgress.correct++;
                progress.set(currentWord.portuguese, wordProgress);
            } else {
                feedbackMessageEl.textContent = `Incorreto. A resposta correta era: ${bestMatch}`;
                feedbackMessageEl.classList.add('incorrect');
                answerInput.classList.add('incorrect');
                const wordProgress = progress.get(currentWord.portuguese) || { correct: 0, incorrect: 0, lastSeen: 0 };
                wordProgress.incorrect++;
                progress.set(currentWord.portuguese, wordProgress);
            }

            isAnswered = true;
            answerInput.setAttribute('disabled', 'true');
            checkButton.textContent = 'Próxima';
            checkButton.classList.remove('check-button');
            checkButton.classList.add('next-button');
            
            infoIcon.classList.add('visible');
        }

        function showAlternativeTranslations() {
            if (!currentWord) return;

            alternativesListContent.innerHTML = '';
            const mainTranslation = selectedDirection === 'pt-en' ? currentWord.english : currentWord.portuguese;
            const mainWord = selectedDirection === 'pt-en' ? currentWord.portuguese : currentWord.english;

            const mainItem = document.createElement('p');
            mainItem.innerHTML = `<strong>${mainWord}</strong>: ${mainTranslation}`;
            alternativesListContent.appendChild(mainItem);

            const exampleItem = document.createElement('p');
            if (currentWord.example) {
                exampleItem.innerHTML = `<em>Exemplo: "${currentWord.example}"</em>`;
                alternativesListContent.appendChild(exampleItem);
            }

            if (currentWord.alternatives && currentWord.alternatives.length > 0) {
                const alternativeHeader = document.createElement('p');
                alternativeHeader.innerHTML = '<strong>Outras traduções:</strong>';
                alternativesListContent.appendChild(alternativeHeader);
                
                currentWord.alternatives.forEach(alt => {
                    const altItem = document.createElement('p');
                    altItem.classList.add('translation-item');
                    altItem.innerHTML = `<strong>${alt.translation}</strong>`;
                    if (alt.example) {
                        altItem.innerHTML += ` <br><em>Exemplo: "${alt.example}"</em>`;
                    }
                    alternativesListContent.appendChild(altItem);
                });
            }
            alternativeTranslationsBox.style.display = 'block';
        }

        function hideAlternativeTranslations() {
            alternativeTranslationsBox.style.display = 'none';
        }
        
        function showDirectionOverlay() {
            gameSelectionOverlay.style.display = 'none';
            directionOverlay.style.display = 'flex';
        }

        function showWelcomeOverlay() {
            directionOverlay.style.display = 'none';
            
            let introText = "Seu objetivo é traduzir as palavras do português para o inglês.";
            if (selectedDirection === 'en-pt') {
                introText = "Seu objetivo é traduzir as palavras do inglês para o português.";
            }
            welcomeText.textContent = introText;
            
            welcomeOverlay.style.display = 'flex';
        }

        function startGame() {
            welcomeOverlay.style.display = 'none';
            mainContentWrapper.style.opacity = '1';
            mainContentWrapper.style.visibility = 'visible';
            
            currentVocabulary = filterVocabulary(selectedCategory);
            if (currentVocabulary.length > 0) {
                showNextWord();
            } else {
                wordToTranslateEl.textContent = 'Nenhuma palavra para este treino.';
                answerInput.style.display = 'none';
                checkButton.style.display = 'none';
            }
        }

        function showCustomWordsMenu() {
            gameSelectionOverlay.style.display = 'none';
            customWordsOverlay.style.display = 'flex';
            renderSelectedWords();
        }
        
        function renderSelectedWords() {
            selectedWordsContainer.innerHTML = '';
            if (customWords.size === 0) {
                selectedWordsContainer.innerHTML = '<p class="custom-words-notice">Nenhuma palavra selecionada. Use a busca para adicionar.</p>';
                startCustomGameButton.disabled = true;
                return;
            }
            
            startCustomGameButton.disabled = false;
            
            const sortedWords = Array.from(customWords).sort();

            sortedWords.forEach(portugueseWord => {
                const word = vocabulary.find(w => w.portuguese === portugueseWord);
                if (word) {
                    const item = document.createElement('div');
                    item.classList.add('selected-word-item');
                    item.innerHTML = `
                        <span>${word.portuguese} (${word.english})</span>
                        <button class="action-button remove-button" data-portuguese="${word.portuguese}">x</button>
                    `;
                    selectedWordsContainer.appendChild(item);
                }
            });
            
            document.querySelectorAll('.remove-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const wordToRemove = event.target.dataset.portuguese;
                    customWords.delete(wordToRemove);
                    renderSelectedWords();
                });
            });
        }

        // Event Listeners
        checkButton.addEventListener('click', checkAnswer);
        
        // Aceita Enter para verificar a resposta
        answerInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        });

        // Aceita Espaço para próxima pergunta quando já respondida
        document.addEventListener('keydown', (event) => {
            if (isAnswered && event.key === ' ') {
                event.preventDefault();
                showNextWord();
            }
        });

        // Toggle de traduções alternativas com o ícone 'i' e a tecla '/'
        infoIcon.addEventListener('click', () => {
            if (alternativeTranslationsBox.style.display === 'block') {
                hideAlternativeTranslations();
            } else {
                showAlternativeTranslations();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === '/' && isAnswered) {
                event.preventDefault();
                if (alternativeTranslationsBox.style.display === 'block') {
                    hideAlternativeTranslations();
                } else {
                    showAlternativeTranslations();
                }
            }
        });
        
        gameSelectionButtonsContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.tagName === 'BUTTON' && target.id !== 'dictionary-button') {
                document.querySelector('#game-selection-buttons button.selected')?.classList.remove('selected');
                target.classList.add('selected');
                selectedCategory = target.dataset.category;
                
                if (selectedCategory === 'custom-words') {
                    selectGameButton.textContent = 'Selecionar Palavras';
                } else {
                    selectGameButton.textContent = 'Próximo';
                }
            }
        });

        dictionaryButton.addEventListener('click', () => {
            window.location.href = 'dicionario01.html'; 
        });

        selectGameButton.addEventListener('click', () => {
            if (selectedCategory === 'custom-words') {
                showCustomWordsMenu();
            } else {
                showDirectionOverlay();
            }
        });
        
        directionButtonsContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.tagName === 'BUTTON') {
                document.querySelector('#direction-buttons button.selected')?.classList.remove('selected');
                target.classList.add('selected');
                selectedDirection = target.dataset.direction;
            }
        });

        selectDirectionButton.addEventListener('click', showWelcomeOverlay);
        
        startButton.addEventListener('click', startGame);

        searchInput.addEventListener('input', (event) => {
            const query = event.target.value.toLowerCase().trim();
            searchResultsList.innerHTML = '';
            searchResultsList.style.display = 'none';

            if (query.length > 1) {
                const results = vocabulary.filter(word => 
                    word.portuguese.toLowerCase().includes(query) || 
                    word.english.toLowerCase().includes(query)
                );
                
                if (results.length > 0) {
                    searchResultsList.style.display = 'block';
                    results.forEach(word => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('search-item');
                        listItem.innerHTML = `
                            <div class="word-info">
                                <strong>${word.portuguese}</strong>
                                <em>${word.english}</em>
                            </div>
                            <button class="action-button add-button" data-portuguese="${word.portuguese}">+</button>
                        `;
                        searchResultsList.appendChild(listItem);
                    });
                    
                    document.querySelectorAll('.add-button').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const wordToAdd = event.target.dataset.portuguese;
                            customWords.add(wordToAdd);
                            renderSelectedWords();
                            searchInput.value = '';
                            searchResultsList.style.display = 'none';
                        });
                    });
                }
            }
        });

        startCustomGameButton.addEventListener('click', () => {
            customWordsOverlay.style.display = 'none';
            showDirectionOverlay();
        });
    });
</script>
</html>
